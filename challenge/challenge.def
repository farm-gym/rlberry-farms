Bootstrap: docker
From: nvidia/cuda:11.7.1-base-ubuntu22.04

%post
    apt-get -y update
    apt-get -y install python3 python3-pip git vim redis  ffmpeg libsm6 libxext6 sudo
    pip3 install -U pip
    pip3 install notebook tabulate toml seaborn docopt dill
    pip3 install rq
    mkdir /home/challenge_env
    cd /home/challenge_env
    git clone https://gitlab.inria.fr/scool/rlberry-farms
    cd rlberry-farms
    git checkout singularity_challenge
    pip install -e .
    cp challenge/farmscool_internal /usr/bin/farmscool
    chmod +x /usr/bin/farmscool
    mkdir /challenge_bin
    cp -r challenge/* /challenge_bin
    cp -r examples/* /challenge_bin
    chown -R challenger:users /challenge_bin
    chmod +xr /challenge_bin/*

%environment
    export LC_ALL=C
    export challenge_data_dir=/mnt/

%startscript
    exec redis-server &
    exec python3 /challenge_bin/rq_worker.py >> /mnt/logfile.log 2>&1


%runscript
    farmscool "$@"
    
%labels
    Author anonymous_berries_eater

%help
    sudo singularity build challenge.sif challenge.def        
    singularity instance start --bind /data:/mnt --nv challenge.sif challenge
    singularity run instance://challenge play 1
